{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/forecast.css' %}">
{% endblock %}
{% block title %}Price Forecast - Predictr{% endblock %}

{% block content %}
<div class="forecast-container">
    <div class="forecast-sidebar">
        <h2>Configuration</h2>
        
        <form method="post" action="{% url 'forecast:run_forecast' %}" id="forecast-form">
            {% csrf_token %}
            
            <div class="form-section">
                <label>Select Asset</label>
                <select name="asset" class="form-select" required>
                    <option value="">Choose asset...</option>
                    {% for asset in assets %}
                    <option value="{{ asset.symbol }}" {% if latest_forecast.asset.symbol == asset.symbol %}selected{% endif %}>
                        {{ asset.name }} ({{ asset.symbol }})
                    </option>
                    {% endfor %}
                </select>
                <div class="recent-assets">
                    <span>Recent:</span>
                    <button type="button" class="asset-btn" data-symbol="SOL/USD">SOL</button>
                    <button type="button" class="asset-btn" data-symbol="TSLA">TSLA</button>
                </div>
            </div>
            
            <div class="form-section">
                <label>Prediction Horizon</label>
                <input type="range" name="horizon" min="1" max="30" value="{{ latest_forecast.prediction_horizon_days|default:7 }}" class="slider" id="horizon-slider">
                <div class="slider-value">
                    <span id="horizon-value">{{ latest_forecast.prediction_horizon_days|default:7 }} Days</span>
                </div>
            </div>
            
            <div class="form-section">
                <label>Risk Tolerance</label>
                <input type="range" name="risk" min="0" max="2" value="1" class="slider" id="risk-slider">
                <div class="slider-value">
                    <span id="risk-value">Medium</span>
                </div>
            </div>
            
            <div class="form-section">
                <label>Indicators</label>
                <div class="toggle-group">
                    <label class="toggle">
                        <input type="checkbox" name="rsi_divergence" checked>
                        <span class="toggle-label">RSI Divergence</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" name="macd_crossover">
                        <span class="toggle-label">MACD Crossover</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" name="sentiment_analysis" checked>
                        <span class="toggle-label">Sentiment Analysis</span>
                    </label>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">
                <span>âš¡</span> Run Prediction
            </button>
            <button type="reset" class="btn btn-secondary btn-block">Reset Parameters</button>
        </form>
    </div>
    
    <div class="forecast-main">
        <div class="page-header">
            <div>
                {% if latest_forecast %}
                    <h1>{{ latest_forecast.asset.name }} ({{ latest_forecast.asset.symbol }}) Price Forecast</h1>
                {% else %}
                    <h1>Market Price Forecast</h1>
                {% endif %}
                <p>Model V4.2 â€¢ Updated 2 mins ago</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary">Share</button>
                <button class="btn btn-secondary">Export Report</button>
            </div>
        </div>
        
        {% if latest_forecast %}
        <div class="forecast-cards">
            <div class="forecast-card">
                <div class="card-label">Current Price</div>
                <div class="card-value">${{ latest_forecast.current_price|floatformat:2 }}</div>
                <div class="card-change neutral">{{ latest_forecast.asset.symbol }}</div>
            </div>
            <div class="forecast-card">
                <div class="card-label">Predicted High ({{ latest_forecast.prediction_horizon_days }}d)</div>
                <div class="card-value">${{ latest_forecast.predicted_high|floatformat:2 }}</div>
            </div>
            <div class="forecast-card">
                <div class="card-label">Predicted Low ({{ latest_forecast.prediction_horizon_days }}d)</div>
                <div class="card-value">${{ latest_forecast.predicted_low|floatformat:2 }}</div>
            </div>
            <div class="forecast-card">
                <div class="card-label">Confidence Score</div>
                <div class="card-value">{{ latest_forecast.confidence_score }}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ latest_forecast.confidence_score }}%"></div>
                </div>
            </div>
        </div>
        
        <div class="forecast-chart-section">
            <div class="chart-header">
                <h3>Price Forecast vs Historical Data</h3>
                <div class="timeframe-selector">
                    <button class="timeframe-btn">1D</button>
                    <button class="timeframe-btn">1W</button>
                    <button class="timeframe-btn active">1M</button>
                    <button class="timeframe-btn">3M</button>
                    <button class="timeframe-btn">1Y</button>
                </div>
            </div>
            <div class="chart-legend">
                <span class="legend-item"><span class="legend-dot predicted"></span> Predicted</span>
                <span class="legend-item"><span class="legend-dot confidence"></span> Confidence Interval</span>
            </div>
            <div class="chart-container-large">
                <canvas id="forecastChart"></canvas>
            </div>
        </div>

        <div class="forecast-info-grid">
            <div class="info-card">
                <h3>AI Market Summary</h3>
                <p class="info-subtitle">Based on technical & sentiment analysis</p>
                <p class="info-text">
                    {{ latest_forecast.summary|default:"Our models are processing the trend data for this asset..." }}
                </p>
                <p class="info-meta">Processing time: 1.2s <a href="#">View detailed logs</a></p>
            </div>
            
            <div class="info-card">
                <h3>PATTERNS DETECTED</h3>
                <div class="pattern-list">
                    <div class="pattern-item-detected">
                        <span class="pattern-icon">ðŸš©</span>
                        <div class="pattern-details">
                            <div class="pattern-name">Bullish Flag</div>
                            <div class="pattern-timeframe">4H Timeframe</div>
                        </div>
                        <div class="pattern-match">92% Match</div>
                    </div>
                    </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state" style="text-align: center; padding: 50px;">
            <p>No forecasts yet. Select an asset and run a forecast to see results.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Slider updates
    const horizonSlider = document.getElementById('horizon-slider');
    const horizonValue = document.getElementById('horizon-value');
    if (horizonSlider) {
        horizonSlider.addEventListener('input', (e) => {
            horizonValue.textContent = e.target.value + ' Days';
        });
    }
    
    const riskSlider = document.getElementById('risk-slider');
    const riskValue = document.getElementById('risk-value');
    const riskLabels = ['Low', 'Medium', 'High'];
    if (riskSlider) {
        riskSlider.addEventListener('input', (e) => {
            riskValue.textContent = riskLabels[e.target.value];
        });
    }
    
    // Asset button clicks - updates the select dropdown
    document.querySelectorAll('.asset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const select = document.querySelector('select[name="asset"]');
            select.value = btn.dataset.symbol;
        });
    });
    
    // Forecast Chart
    const forecastCtx = document.getElementById('forecastChart');
    if (forecastCtx) {
        const labels = [
            {% for point in latest_points %}
            '{{ point.date|date:"M d" }}',
            {% endfor %}
        ].filter(l => l !== "");

        const predicted = [
            {% for point in latest_points %}
            {{ point.predicted_price|default:0 }},
            {% endfor %}
        ].map(Number);

        const upper = [
            {% for point in latest_points %}
            {{ point.confidence_upper|default:0 }},
            {% endfor %}
        ].map(Number);

        const lower = [
            {% for point in latest_points %}
            {{ point.confidence_lower|default:0 }},
            {% endfor %}
        ].map(Number);

        const hasData = labels.length > 0;
        const fallbackLabels = ['No Data'];
        const fallbackData = [0];

        new Chart(forecastCtx, {
            type: 'line',
            data: {
                labels: hasData ? labels : fallbackLabels,
                datasets: [{
                    label: 'Predicted',
                    data: hasData ? predicted : fallbackData,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    pointRadius: 3,
                    tension: 0.4,
                    fill: false
                }, {
                    label: 'Confidence Interval',
                    data: hasData ? upper : [],
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: '+1' // Fills to the next dataset (lower)
                }, {
                    label: 'Lower Bound',
                    data: hasData ? lower : [],
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#9ca3af' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9ca3af' }
                    }
                }
            }
        });
    }
</script>
{% endblock %}